<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ã‚ŠãŒã¨ã†ã® ã¦ãŒã¿ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ (AI ver)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap');

        body {
            font-family: 'Kosugi Maru', sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #ff8c00;
            font-size: 28px;
            margin-bottom: 10px;
            border-bottom: 3px dashed #ff8c00;
            padding-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .step-box {
            background-color: #fff9e6;
            border: 2px solid #ffcc00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
        }

        .step-number {
            background-color: #ff8c00;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            position: absolute;
            top: -15px;
            left: 20px;
        }

        h3 {
            margin-top: 10px;
            font-size: 20px;
            color: #444;
        }

        .guide-text {
            font-size: 14px;
            color: #555;
            background-color: #e6f2ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px dashed #aaa;
            border-radius: 8px;
            background-color: #fafafa;
            font-family: 'Kosugi Maru', sans-serif;
            margin-top: 5px;
            box-sizing: border-box;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #ff8c00;
            background-color: #fff;
        }

        .hint-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        /* ç”»åƒä»˜ããƒ’ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .hint-card {
            background-color: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 140px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .hint-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #8b5cf6;
        }
        .hint-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background-color: #eee;
        }
        .hint-card p {
            padding: 8px;
            font-size: 13px;
            margin: 0;
            text-align: center;
            background-color: #f9fafb;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }
        
        /* å¾“æ¥ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚¿ã‚° */
        .hint-tag {
            background-color: #e0e0e0;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-block;
        }
        .hint-tag:hover {
            background-color: #bcd4e6;
        }

        .ai-generated-tag {
            background-color: #d1fae5; /* Light green for AI suggestions */
            border: 1px solid #10b981;
            color: #065f46;
        }
        .ai-generated-tag:hover {
            background-color: #a7f3d0;
        }

        .emotion-options {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emotion-btn {
            background-color: white;
            border: 2px solid #888;
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            text-align: center;
            width: 120px;
        }

        .emotion-btn.selected {
            border-color: #ff8c00;
            background-color: #fff4e0;
            font-weight: bold;
        }

        .emotion-icon {
            font-size: 30px;
            display: block;
        }

        /* è‡ªç”±è¨˜è¿°ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .other-emotion-box {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }
        .other-emotion-label {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        .final-draft {
            background-color: #f0fff0;
            border: 3px double #32cd32;
            padding: 25px;
            border-radius: 10px;
            margin-top: 40px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-generate {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 15px;
            background-color: #32cd32;
            color: white;
            text-align: center;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-generate:active { transform: translateY(2px); }

        .btn-check {
            padding: 12px 24px;
            background-color: #ff8c00;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #cc7000;
            transition: transform 0.1s;
        }
        .btn-check:active { transform: translateY(4px); box-shadow: none; }

        .btn-print {
            padding: 12px 24px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        /* AI Buttons */
        .btn-ai {
            background-color: #8b5cf6; /* Purple */
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
            margin-top: 10px;
        }
        .btn-ai:hover { background-color: #7c3aed; }
        .btn-ai:disabled { background-color: #c4b5fd; cursor: not-allowed; }

        #checkMessage {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            text-align: left;
        }
        .msg-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .msg-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .msg-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* Loading Overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ãƒ’ãƒ³ãƒˆç”»åƒã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
        .img-placeholder {
            width: 100%;
            height: 100px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 10px;
            text-align: center;
            padding: 5px;
            box-sizing: border-box;
            word-break: break-all;
        }

        @media print {
            body { background-color: white; }
            .container { box-shadow: none; width: 100%; max-width: 100%; padding: 0; }
            .btn-generate, .button-group, .hint-tag, .step-number, .btn-ai, .hint-container { display: none; }
            input, textarea { border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top: 10px; color: #8b5cf6; font-weight: bold;">AIãŒ ã‹ã‚“ãŒãˆã¦ã„ã¾ã™...</p>
</div>

<div class="container">
    <h1>ã‚ã‚ŠãŒã¨ã†ã® ã¦ãŒã¿ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ</h1>
    <p class="subtitle">ã—ã¤ã‚‚ã‚“ã« ã“ãŸãˆã¦ã€ã‚ã‚ŠãŒã¨ã†ã® ã¶ã‚“ã—ã‚‡ã†ã‚’ ã¤ãã‚ã†ï¼</p>

    <!-- STEP 1 -->
    <div class="step-box">
        <span class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 1</span>
        <h3>ã ã‚Œã« ã‹ãï¼Ÿ</h3>
        <div class="guide-text">
            ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’ ã¤ãŸãˆãŸã„ äººã® åå‰ã‚’ ã‹ã“ã†ã€‚
        </div>
        <input type="text" id="who" placeholder="ï¼ˆä¾‹ï¼‰ãŠæ¯ã•ã‚“ã€å…ˆç”Ÿã€ã€‡ã€‡ãã‚“">
    </div>

    <!-- STEP 2 -->
    <div class="step-box">
        <span class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 2</span>
        <h3>ãªã«ã‚’ ã—ã¦ãã‚ŒãŸï¼Ÿ</h3>
        <div class="guide-text">
            ãã®äººã¯ã€ã‚ãªãŸã« ãªã«ã‚’ ã—ã¦ãã‚ŒãŸã‹ãªï¼Ÿ<br>
            æ€ã„å‡ºã›ãªã„ã¨ãã¯ã€ã€ŒAIãƒ’ãƒ³ãƒˆã€ã‚’ãŠã—ã¦ã¿ã‚ˆã†ã€‚
        </div>
        <input type="text" id="what" placeholder="ï¼ˆä¾‹ï¼‰é‡ã„è·ç‰©ã‚’æŒã£ã¦ãã‚ŒãŸã€ã‚ãã‚“ã§ãã‚ŒãŸ">
        
        <button class="btn-ai" onclick="getAIHints()">
            âœ¨ AIãƒ’ãƒ³ãƒˆ (ã‚¤ãƒ©ã‚¹ãƒˆã§ ã¿ã‚‹)
        </button>

        <div class="hint-container" id="hintContainer">
            <span class="hint-tag" onclick="setInput('what', 'ã„ã£ã—ã‚‡ã« ã‚ãã‚“ã§ãã‚ŒãŸ')">ã„ã£ã—ã‚‡ã« ã‚ãã‚“ã§ãã‚ŒãŸ</span>
            <span class="hint-tag" onclick="setInput('what', 'ã¹ã‚“ãã‚‡ã†ã‚’ ãŠã—ãˆã¦ãã‚ŒãŸ')">ã¹ã‚“ãã‚‡ã†ã‚’ ãŠã—ãˆã¦ãã‚ŒãŸ</span>
            <span class="hint-tag" onclick="setInput('what', 'ãŠã¨ã—ã‚‚ã®ã‚’ ã²ã‚ã£ã¦ãã‚ŒãŸ')">ãŠã¨ã—ã‚‚ã®ã‚’ ã²ã‚ã£ã¦ãã‚ŒãŸ</span>
            <span class="hint-tag" onclick="setInput('what', 'ã¯ãªã—ã‚’ ãã„ã¦ãã‚ŒãŸ')">ã¯ãªã—ã‚’ ãã„ã¦ãã‚ŒãŸ</span>
        </div>
    </div>

    <!-- STEP 3 -->
    <div class="step-box">
        <span class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 3</span>
        <h3>ã©ã‚“ãª ãã‚‚ã¡ ã ã£ãŸï¼Ÿ</h3>
        <div class="guide-text">
            ãã®ã¨ãã€ã‚ãªãŸã¯ ã©ã† ãŠã‚‚ã£ãŸã‹ãªï¼Ÿ ãˆã‚‰ã‚“ã§ã¿ã‚ˆã†ã€‚<br>
            ã‚‚ã— ã¡ãŒã†ãã‚‚ã¡ãªã‚‰ã€ã—ãŸã® ã¯ã“ã« ã‹ã„ã¦ã­ã€‚
        </div>
        <div class="emotion-options">
            <div class="emotion-btn" onclick="selectEmotion(this, 'ã†ã‚Œã—ã‹ã£ãŸ')">
                <span class="emotion-icon">ğŸ˜Š</span>
                ã†ã‚Œã—ã‹ã£ãŸ
            </div>
            <div class="emotion-btn" onclick="selectEmotion(this, 'ãŸã®ã—ã‹ã£ãŸ')">
                <span class="emotion-icon">ğŸ˜†</span>
                ãŸã®ã—ã‹ã£ãŸ
            </div>
            <div class="emotion-btn" onclick="selectEmotion(this, 'ãŸã™ã‹ã£ãŸ')">
                <span class="emotion-icon">ğŸ˜Œ</span>
                ãŸã™ã‹ã£ãŸ
            </div>
            <div class="emotion-btn" onclick="selectEmotion(this, 'ã»ã£ã¨ã—ãŸ')">
                <span class="emotion-icon">â˜•</span>
                ã»ã£ã¨ã—ãŸ
            </div>
        </div>
        <input type="hidden" id="feeling">
        
        <!-- è‡ªç”±è¨˜è¿°è¿½åŠ  -->
        <div class="other-emotion-box">
            <label class="other-emotion-label">ãã®ã»ã‹ã® ãã‚‚ã¡ï¼ˆã˜ã¶ã‚“ã§ ã‹ãï¼‰</label>
            <input type="text" id="otherFeeling" placeholder="ï¼ˆä¾‹ï¼‰ã³ã£ãã‚Šã—ãŸã€ãƒ‰ã‚­ãƒ‰ã‚­ã—ãŸ" oninput="clearEmotionSelection()">
        </div>
    </div>

    <!-- STEP 4 -->
    <div class="step-box">
        <span class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 4</span>
        <h3>ã“ã‚Œã‹ã‚‰ ã©ã†ã—ãŸã„ï¼Ÿï¼ˆãŠã¾ã‘ï¼‰</h3>
        <div class="guide-text">
            ã“ã‚Œã‹ã‚‰ ãã®äººã¨ ã©ã†ã—ãŸã„ã‹ãªï¼Ÿ
        </div>
        <input type="text" id="future" placeholder="ï¼ˆä¾‹ï¼‰ã¾ãŸ ã‚ãã³ãŸã„ã§ã™ã€ã“ã‚Œã‹ã‚‰ã‚‚ ã‚ˆã‚ã—ãã­">
        <div class="hint-container">
            <span class="hint-tag" onclick="setInput('future', 'ã¾ãŸ ã‚ãã³ãŸã„ã§ã™')">ã¾ãŸ ã‚ãã³ãŸã„ã§ã™</span>
            <span class="hint-tag" onclick="setInput('future', 'ã“ã‚Œã‹ã‚‰ã‚‚ ãªã‹ã‚ˆãã—ã¦ã­')">ã“ã‚Œã‹ã‚‰ã‚‚ ãªã‹ã‚ˆãã—ã¦ã­</span>
            <span class="hint-tag" onclick="setInput('future', 'ã“ã‚Œã‹ã‚‰ã‚‚ ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™')">ã“ã‚Œã‹ã‚‰ã‚‚ ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™</span>
        </div>
    </div>

    <button class="btn-generate" onclick="generateLetter()">ã¶ã‚“ã—ã‚‡ã†ã‚’ ã¤ãã‚‹ï¼</button>

    <!-- FINAL OUTPUT -->
    <div class="final-draft">
        <h3>âœ¨ ã§ãã‚ãŒã£ãŸ ã¦ãŒã¿ âœ¨</h3>
        <textarea id="finalText" rows="8" placeholder="ã“ã“ã« æ–‡ç« ãŒ ã§ãã‚ãŒã‚Šã¾ã™ã€‚"></textarea>
        
        <div style="text-align: right;">
            <button class="btn-ai" onclick="polishTextWithAI()">
                âœ¨ é­”æ³•ã®ãƒšãƒ³ (ã‚‚ã£ã¨ ã™ã¦ãã«)
            </button>
        </div>

        <!-- Check Message Area -->
        <div id="checkMessage"></div>

        <div class="button-group">
            <button class="btn-check" onclick="checkText()">ğŸ‘€ ã¾ã¡ãŒã„ãŒãªã„ã‹ ãƒã‚§ãƒƒã‚¯</button>
            <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ã„ã‚“ã•ã¤ã™ã‚‹</button>
        </div>
    </div>

</div>

<script>
    const apiKey = ""; // Environment will inject key

    // --- Gemini & Imagen API Logic ---

    // Text Generation (Gemini)
    async function callGeminiAPI(userPrompt) {
        // Validation removed as per system prompt

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: userPrompt }] }] };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                // If 401/403, it means key is invalid or not injected
                if (response.status === 401) throw new Error("401 Unauthorized");
                throw new Error(`Error: ${response.status}`);
            }
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (error) {
            console.error('Gemini API Error:', error);
            showMessage("AIã«ã¤ãªãŒã‚‰ãªã‹ã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ã„ã¡ã© ãŸã‚ã—ã¦ã¿ã¦ã­ã€‚", "error");
            return null;
        }
    }

    // Image Generation (Imagen)
    async function callImagenAPI(imagePrompt) {
        // Basic validation
        if (!imagePrompt) return { success: false, error: "No Prompt" };

        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        
        const payload = {
            instances: [{ prompt: imagePrompt }],
            parameters: { sampleCount: 1 }
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorJson = await response.json().catch(() => ({}));
                const errorMessage = errorJson.error?.message || response.statusText;
                console.error("Imagen API Error Details:", errorMessage);
                
                // Return generic failure so we can fallback to emoji
                return { success: false, error: errorMessage };
            }

            const data = await response.json();
            
            if (!data.predictions || !data.predictions[0] || !data.predictions[0].bytesBase64Encoded) {
                return { success: false, error: "ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—" };
            }

            return { success: true, image: data.predictions[0].bytesBase64Encoded };
        } catch (error) {
            console.error('Imagen Network Error:', error);
            return { success: false, error: "é€šä¿¡ã‚¨ãƒ©ãƒ¼" };
        }
    }

    async function getAIHints() {
        const who = document.getElementById('who').value;
        if (!who) {
            showMessage("ã‚¹ãƒ†ãƒƒãƒ—1ã§ã€Œã ã‚Œã«ã€ã‚’ã„ã‚Œã¦ã‹ã‚‰ ãŠã—ã¦ã­ï¼", "warning");
            return;
        }

        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        // Update Prompt to ask for Emoji fallback
        const prompt = `
        å¯¾è±¡è€…: "${who}"
        ASDã®å…ç«¥ãŒã€ã“ã®å¯¾è±¡è€…ã«å‘ã‘ã¦æ„Ÿè¬ã®æ‰‹ç´™ã‚’æ›¸ã“ã†ã¨ã—ã¦ã„ã¾ã™ã€‚
        ã“ã®å¯¾è±¡è€…ãŒå…ç«¥ã«ã—ã¦ãã‚ŒãŸã‹ã‚‚ã—ã‚Œãªã„ã€å…·ä½“çš„ã§è¦ªåˆ‡ãªè¡Œå‹•ã‚’3ã¤è€ƒãˆã¦ãã ã•ã„ã€‚
        
        æ¡ä»¶:
        1. æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ: å°å­¦ç”Ÿã§ã‚‚èª­ã‚ã‚‹ç°¡å˜ãªè¨€è‘‰ï¼ˆã²ã‚‰ãŒãªå¤šã‚ï¼‰ã€‚ã€Œã€œã—ã¦ãã‚ŒãŸã€ã¨ã„ã†å½¢ã€‚
        2. ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(è‹±èª): ãã®è¡Œå‹•ã‚’æå†™ã™ã‚‹ã€"Japanese anime style illustration" (æ—¥æœ¬ã®ã‚¢ãƒ‹ãƒ¡é¢¨ã‚¤ãƒ©ã‚¹ãƒˆ)ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‚æ¸©ã‹ã„é›°å›²æ°—ã§ã€‚
        3. çµµæ–‡å­—: è¡Œå‹•ã‚’è¡¨ã™çµµæ–‡å­—ã‚’1ã¤ã€‚
        4. å‡ºåŠ›å½¢å¼: ä»¥ä¸‹ã®JSONé…åˆ—ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        [
            { "text": "ã”ã¯ã‚“ã‚’ ã¤ãã£ã¦ãã‚ŒãŸ", "image_prompt": "...", "emoji": "ğŸ³" },
            ...
        ]
        `;

        const resultText = await callGeminiAPI(prompt);
        
        if (!resultText) {
            loadingOverlay.style.display = 'none';
            return;
        }

        try {
            const cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
            const hints = JSON.parse(cleanJson);
            
            loadingOverlay.style.display = 'none'; 
            
            const container = document.getElementById('hintContainer');
            
            // Loop through hints
            for (const hint of hints) {
                const card = document.createElement('div');
                card.className = 'hint-card';
                card.onclick = function() { setInput('what', hint.text); };
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-placeholder';
                // Start with loading spinner
                imgContainer.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div>';
                
                const p = document.createElement('p');
                p.textContent = hint.text;
                
                card.appendChild(imgContainer);
                card.appendChild(p);
                
                if (container.firstChild) {
                    container.insertBefore(card, container.firstChild);
                } else {
                    container.appendChild(card);
                }

                // Call Imagen - if fail, fallback to emoji
                callImagenAPI(hint.image_prompt).then(result => {
                    if (result.success && result.image) {
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${result.image}`;
                        img.alt = hint.text;
                        imgContainer.replaceWith(img);
                    } else {
                        // Fallback to Emoji
                        imgContainer.innerHTML = `<span style="font-size: 40px; line-height: 1;">${hint.emoji || 'ğŸ’¡'}</span>`;
                        imgContainer.style.backgroundColor = '#f3f4f6';
                        imgContainer.title = "ç”»åƒç”ŸæˆãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€çµµæ–‡å­—ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™";
                    }
                });
            }
            
            showMessage(`AIãŒã€Œ${who}ã€ã•ã‚“ãŒ ã—ã¦ãã‚Œãã†ãªã“ã¨ã‚’ ã‚¤ãƒ©ã‚¹ãƒˆ(ã¾ãŸã¯çµµæ–‡å­—)ã«ã—ãŸã‚ˆï¼`, "success");

        } catch (e) {
            loadingOverlay.style.display = 'none';
            console.error("JSON Parse Error", e);
            showMessage("ãƒ’ãƒ³ãƒˆã‚’ ã†ã¾ã ã¤ãã‚Œãªã‹ã£ãŸã‚ˆã€‚ã”ã‚ã‚“ã­ã€‚", "error");
        }
    }

    async function polishTextWithAI() {
        const currentText = document.getElementById('finalText').value;
        if (!currentText || currentText.length < 5) {
            showMessage("ã¾ãšã¯ã€Œã¶ã‚“ã—ã‚‡ã†ã‚’ ã¤ãã‚‹ï¼ã€ã‚’ãŠã—ã¦ã€ã¦ãŒã¿ã‚’ ã‹ã„ã¦ã­ã€‚", "warning");
            return;
        }
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        const prompt = `
        ã‚ãªãŸã¯å„ªã—ã„å­¦æ ¡ã®å…ˆç”Ÿã§ã™ã€‚å­ä¾›ãŒæ›¸ã„ãŸä»¥ä¸‹ã®æ‰‹ç´™ã‚’ã€å°‘ã—ã ã‘è‡ªç„¶ã§æ¸©ã‹ã„æ–‡ç« ã«ç›´ã—ã¦ãã ã•ã„ã€‚
        
        å…ƒã®æ‰‹ç´™:
        "${currentText}"

        æ¡ä»¶:
        1. å­ä¾›ã®ç´ ç›´ãªã€Œå£°ã€ã‚„ã€Œæ–‡ä½“ã€ã¯æ®‹ã—ã¦ãã ã•ã„ã€‚å¤§äººã®é›£ã—ã„è¨€è‘‰ã«å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚
        2. æ–‡æ³•ã®é–“é•ã„ï¼ˆã€Œã¦ã«ãŠã¯ã€ãªã©ï¼‰ãŒã‚ã‚Œã°ç›´ã—ã¦ãã ã•ã„ã€‚
        3. æœ€å¾Œã«ä¸€è¨€ã€ç›¸æ‰‹ãŒå¬‰ã—ããªã‚‹ã‚ˆã†ãªçŸ­ã„è¨€è‘‰ã‚’è¶³ã—ã¦ã‚‚è‰¯ã„ã§ã™ã€‚
        4. å‡ºåŠ›ã¯ä¿®æ­£å¾Œã®æœ¬æ–‡ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚
        `;

        const polishedText = await callGeminiAPI(prompt);
        loadingOverlay.style.display = 'none';

        if (polishedText) {
            document.getElementById('finalText').value = polishedText.trim();
            showMessage("é­”æ³•ã®ãƒšãƒ³ã§ã€ã‚‚ã£ã¨ ã™ã¦ããª ã¦ãŒã¿ã«ãªã£ãŸã‚ˆï¼âœ¨", "success");
        }
    }

    // --- Standard App Logic ---

    function setInput(id, text) {
        document.getElementById(id).value = text;
    }

    function selectEmotion(element, text) {
        // ãƒœã‚¿ãƒ³ãŒé¸ã°ã‚ŒãŸã‚‰ã€è‡ªç”±è¨˜è¿°æ¬„ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
        document.getElementById('otherFeeling').value = '';

        const buttons = document.querySelectorAll('.emotion-btn');
        buttons.forEach(btn => btn.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('feeling').value = text;
    }
    
    // è‡ªç”±è¨˜è¿°æ¬„ã«å…¥åŠ›ãŒã‚ã£ãŸã‚‰ã€ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤ã™ã‚‹
    function clearEmotionSelection() {
        const buttons = document.querySelectorAll('.emotion-btn');
        buttons.forEach(btn => btn.classList.remove('selected'));
        document.getElementById('feeling').value = ''; // hiddenã‚‚ã‚¯ãƒªã‚¢
    }

    function generateLetter() {
        const who = document.getElementById('who').value;
        let what = document.getElementById('what').value.trim().replace(/[ã€‚ã€]+$/, '');
        
        // æ°—æŒã¡ã®å–å¾—å„ªå…ˆåº¦: 1.è‡ªç”±è¨˜è¿° 2.ãƒœã‚¿ãƒ³é¸æŠ
        let feeling = document.getElementById('otherFeeling').value;
        if (!feeling) {
            feeling = document.getElementById('feeling').value;
        }
        
        const future = document.getElementById('future').value;

        if (!who || !what) {
            showMessage('ã€Œã ã‚Œã«ã€ã¨ã€Œãªã«ã‚’ã€ã‚’ ã‹ã„ã¦ã­ï¼', 'warning');
            return;
        }

        let letter = `${who} ã¸\n\n`;

        if (what.endsWith('ãã‚ŒãŸ') || what.endsWith('ã¦ãã‚ŒãŸ')) {
            const stem = what.substring(0, what.length - 3);
            letter += `ã“ã®ã‚ã„ã ã¯ã€${stem}ãã‚Œã¾ã—ãŸã­ã€‚\n`;
        } else if (what.endsWith('ã¾ã—ãŸ')) {
            letter += `ã“ã®ã‚ã„ã ã¯ã€${what}ã­ã€‚\n`;
        } else {
            letter += `ã“ã®ã‚ã„ã ã¯ã€${what} ã§ã™ã­ã€‚\n`;
        }
        
        if (feeling) {
            letter += `ã‚ãŸã—ã¯ã€ã¨ã¦ã‚‚ ${feeling} ã§ã™ã€‚\n`;
        }
        
        letter += `ã‚ã‚ŠãŒã¨ã†ã€‚\n`;

        if (future) {
            letter += `${future}ã€‚\n`;
        }

        document.getElementById('finalText').value = letter;
        document.getElementById('checkMessage').style.display = 'none';
    }

    function checkText() {
        const text = document.getElementById('finalText').value;
        let messages = [];
        let isSuccess = true;

        if (!text.trim()) {
            showMessage("ã¾ã  ãªã«ã‚‚ ã‹ã„ã¦ã„ãªã„ã‚ˆã€‚ã€Œã¶ã‚“ã—ã‚‡ã†ã‚’ ã¤ãã‚‹ï¼ã€ã‚’ãŠã—ã¦ã­ã€‚", 'warning');
            return;
        }

        if (text.includes('ã€‡ã€‡')) {
            messages.push("âš ï¸ ã€Œã€‡ã€‡ã€ã®ã¾ã¾ã® ã¨ã“ã‚ãŒ ã‚ã‚‹ã‚ˆã€‚ãªã¾ãˆã« ãªãŠã—ã¦ã­ã€‚");
            isSuccess = false;
        }

        if (!text.includes('ã‚ã‚ŠãŒã¨ã†')) {
            messages.push("âš ï¸ ã€Œã‚ã‚ŠãŒã¨ã†ã€ã® ã“ã¨ã°ã‚’ ã„ã‚Œã‚ˆã†ï¼");
            isSuccess = false;
        }

        if (text.length < 10) {
            messages.push("âš ï¸ ã¶ã‚“ã—ã‚‡ã†ãŒ ã¿ã˜ã‹ã„ã¿ãŸã„ã€‚ã‚‚ã†ã™ã“ã— ã‹ã„ã¦ã¿ã‚ˆã†ã€‚");
            isSuccess = false;
        }

        if (isSuccess) {
            showMessage("âœ… ãƒãƒƒãƒãƒªï¼ ã¨ã¦ã‚‚ ã‚ˆã„ ã¦ãŒã¿ ã ã­ï¼<br>ï¼ˆã“ãˆã« ã ã—ã¦ ã‚ˆã‚“ã§ã¿ã‚‹ã‚ˆğŸ”Šï¼‰", 'success');
            speakText(text);
        } else {
            showMessage(messages.join('<br>'), 'warning');
        }
    }

    function showMessage(html, type) {
        const msgDiv = document.getElementById('checkMessage');
        msgDiv.style.display = 'block';
        msgDiv.innerHTML = html;
        
        if (type === 'success') msgDiv.className = 'msg-success';
        else if (type === 'error') msgDiv.className = 'msg-error';
        else msgDiv.className = 'msg-warning';
    }

    function speakText(text) {
        if ('speechSynthesis' in window) {
            const uttr = new SpeechSynthesisUtterance();
            uttr.text = text;
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0; 
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(uttr);
        }
    }
</script>

</body>
</html>
